<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Queue Display</title>
    <link rel="icon" type="image/png" sizes="16x16" href="/img/LogoRound.png">
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="reservation-page">
<!-- Navigation Bar -->
<nav class="navbar">
    <div class="navbar-left">
        <div class="navbar-logo">
            <img src="/img/LogoRound.png" alt="Romantic Baboy Logo">
        </div>
        <div class="navbar-brand">Romantic Baboy</div>
    </div>

    <div class="navbar-center">
        ROMANTIC BABOY KOREAN GRILL
    </div>

    <div class="navbar-right">
        <button onclick="openSeatingModal()" class="navbar-btn-active" id="showConfirm">
            Confirm
            <span class="notification-dot" id="seatingNotification"></span>
        </button>
        <button class="navbar-btn" id="cancelbtn" onclick="openCancelModal()">Cancel</button>
        <button class="navbar-btn" id="changebtn" onclick="openModal()">Change Details</button>
        <a href="/logout" class="navbar-btn">Logout</a>
    </div>

    <!-- Mobile Menu Toggle -->
    <button class="navbar-toggle" onclick="toggleMobileMenu()">
        ☰
        <span class="notification-dot" id="mobileMenuNotification"></span>
    </button>
</nav>

<!-- Mobile Menu -->
<div class="navbar-mobile-menu" id="mobileMenu">
    <button onclick="openSeatingModal()" id="showConfirmMobile" class="navbar-btn">
        Confirm Reservation
        <span class="notification-dot"></span>
    </button>
    <button class="navbar-btn" id="cancelbtnmobile" onclick="openCancelModal(); toggleMobileMenu();">Cancel Reservation</button>
    <button class="navbar-btn" id="changebtnmobile" onclick="openModal(); toggleMobileMenu();">Change Details</button>
    <a href="/logout" class="navbar-btn">Logout</a>
</div>

<div class="container">
    <div class="clock-icon"></div>

    <div class="main-card">
        <div class="brand-header">
            <div class="brand-title">ROMANTIC BABOY KOREAN GRILL</div>
        </div>

        <div class="content-grid">
            <div class="customer-info">
                <div class="info-item">
                    Name
                    <span th:text="${customerName}">Loading...</span>
                </div>
                <div class="info-item">
                    Phone
                    <span id="phoneDisplay" th:text="${customerPhone}">Loading...</span>
                </div>
                <div class="info-item">
                    Reference
                    <span th:text="${reference}">Loading...</span>
                </div>
                <div class="info-item" id="queue">
                    Queue
                    <span th:text="${queueNumber}">Loading...</span>
                </div>
                <div class="info-item">
                    Seating Capacity
                    <span th:text="${seatingCapacity} + ' Person'">Loading...</span>
                </div>
                <div class="info-item">
                    Preferred Space
                    <span th:text="${preferredSpace}">Loading...</span>
                </div>
                <div class="info-item">
                    Status
                    <span id="statusLabel" th:text="${status}"
                          th:class="'status-'+ ${#strings.replace(status,' ','-')}">Loading...</span>
                </div>
            </div>

            <div class="timer-section">
                <div class="countdown"
                     id="countup"
                     th:classappend="${status} != null ? ${status} : ''">00:00:00</div>
                <div class="estimated-time" >
                    Created: <span id="createdTime" th:text="${created}">00:00:00</span>
                </div>
            </div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-segment"
             th:each="i : ${#numbers.sequence(1,24)}"
             th:classappend="${i <= activeSegments} ? 'active status-' + ${status} : ''">
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
    <div class="modal-container" onclick="event.stopPropagation()">
        <div class="modal-header">
            <button class="close-button" onclick="closeModal()">&times;</button>
            <div class="modal-title">Change Details</div>
            <div class="modal-subtitle">Romantic Baboy Korean Grill</div>
        </div>

        <div class="modal-body">
            <form id="changeDetailsForm" th:action="@{/updateCustomer}" method="post">
                <div class="form-group">
                    <label class="form-label" for="customerName">Name</label>
                    <input type="text" id="customerName" name="customerName" class="form-input"
                           placeholder="Enter your name" th:value="${customerName}" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="customerPhone">Phone Number</label>
                    <input type="tel" id="customerPhone" name="customerPhone" class="form-input"
                           placeholder="Enter your phone number" th:value="${customerPhone}" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="seatingCapacity">Seating Capacity</label>
                        <select id="seatingCapacity" name="seatingCapacity" class="form-select" required>
                            <option value="">Select...</option>
                            <option value="1">1 Person</option>
                            <option value="2">2 Persons</option>
                            <option value="3">3 Persons</option>
                            <option value="4">4 Persons</option>
                            <option value="5">5 Persons</option>
                            <option value="6">6 Persons</option>
                            <option value="7">7 Persons</option>
                            <option value="8">8 Persons</option>
                            <option value="9">9 Persons</option>
                            <option value="10">10 Persons</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="preferredSpace">Preferred Space</label>
                        <select id="preferredSpace" name="preferredSpace" class="form-select">
                            <option value="">Select...</option>
                            <option value="Indoor">Indoor</option>
                            <option value="Outdoor">Outdoor</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-submit" form="changeDetailsForm">Save Changes</button>
        </div>
    </div>
</div>
<!-- CANCEL RESERVATION MODAL -->
<div class="modal-overlay" id="cancelModalOverlay" onclick="closeCancelModalOnOverlay(event)">
    <div class="modal-container" onclick="event.stopPropagation()">
        <div class="modal-header">
            <button class="close-button" onclick="closeCancelModal()">&times;</button>
            <div class="modal-title">Cancel Reservation</div>
            <div class="modal-subtitle">Romantic Baboy Korean Grill</div>
        </div>

        <div class="modal-body">
            <p>Are you sure you want to cancel this reservation?</p>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeCancelModal()">No, Keep Reservation</button>
            <form th:action="@{/cancelReservation}" method="post" style="display:inline;">
                <input type="hidden" name="reference" th:value="${reference}">
                <button type="submit" class="btn btn-submit">Yes, Cancel</button>
            </form>
        </div>
    </div>
</div>
<div class="seating-modal-overlay" id="seatingModalOverlay">
    <div class="seating-modal-container">
        <div class="seating-modal-icon">
            <div class="seating-modal-icon-circle"></div>
        </div>

        <div class="seating-modal-body">
            <h2 class="seating-modal-title">Your Table is Ready!</h2>
            <p class="seating-modal-message">
                Dear valued guest, your reserved table is now ready. Kindly confirm if you are ready or go to our restaurant and show this
            </p>

            <div class="seating-modal-actions">
                <button class="seating-btn seating-btn-decline" onclick="declineSeating()">
                    Not Yet
                </button>
                <form th:action="@{/confirmReservation}" method="post">
                    <input type="hidden" name="reference" th:value="${reference}">
                    <button type="submit" class="seating-btn seating-btn-confirm" onclick="confirmSeating()">
                        I'm Ready
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    var stompClient = Stomp.client('wss://reservationsystem-ul0w.onrender.com/ws');
    stompClient.reconnect_delay = 5000;

    let currentStatus = /*[[${status}]]*/ "";


    const reference = /*[[${reference}]]*/ "";

    console.log('WS connected for account:', reference);

    if (!reference) {
        console.error("Reference missing — WebSocket disabled");
    } else {

        let seatingShown = false;

        stompClient.connect(
            {},
            function (frame) {
                console.log('Connected: ' + frame);

                stompClient.subscribe('/topic/account.' + reference, function (message) {
                    console.log('Message received:', message.body);

                    if (!seatingShown) {
                        openSeatingModal();
                        notificationIcon();
                        seatingShown = true;
                    }
                });

                if (currentStatus === "Pending") {
                    fetch(`/pendingNotifications?reference=${reference}`)
                        .then(res => {
                            if (!res.ok) {
                                throw new Error("HTTP " + res.status);
                            }
                            return res.json();
                        })
                        .then(data => {
                            if (!Array.isArray(data)) {
                                console.error("Expected array but got:", data);
                                return;
                            }

                            if (data.length > 0 && !seatingShown) {
                                openSeatingModal();
                                notificationIcon();
                                seatingShown = true;
                            }

                            data.forEach(notification => {
                                console.log("Notification:", notification);
                            });
                        })
                        .catch(err =>
                            console.error("Failed to fetch pending notifications:", err)
                        );
                }
            },
            function (error) {
                console.error('STOMP connection failed:', error);
            }
        );
    }


    // ===== TIMEZONE CONVERSION FUNCTIONS =====
    // Convert UTC time string to local Date object
    function convertUTCToLocal(utcString) {
        if (!utcString) return null;

        // Handle different datetime formats from server
        let isoString = utcString;

        // If it's in format "2025-01-11 12:00:00" (space separator, no timezone)
        if (utcString.includes(' ') && !utcString.includes('T')) {
            isoString = utcString.replace(' ', 'T') + 'Z';
        }
        // If it has T but no timezone indicator
        else if (utcString.includes('T') && !utcString.endsWith('Z') && !utcString.includes('+')) {
            isoString = utcString + 'Z';
        }

        const date = new Date(isoString);
        if (isNaN(date.getTime())) {
            console.error('Invalid date:', utcString);
            return null;
        }

        return date;
    }

    // Format date to readable string with AM/PM
    function formatDateTime(date) {
        if (!date) return '';
        return date.toLocaleString(undefined, {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }

    // Convert and display the created time in local timezone
    function displayCreatedTime() {
        const createdElement = document.getElementById('createdTime');
        if (createdElement) {
            const utcTime = createdElement.textContent;
            const localDate = convertUTCToLocal(utcTime);
            if (localDate) {
                createdElement.textContent = formatDateTime(localDate);
            }
        }
    }

    // Call this immediately to convert the created time
    displayCreatedTime();
    // ===== END TIMEZONE CONVERSION =====


    // Mobile menu toggle
    function toggleMobileMenu() {
        const menu = document.getElementById('mobileMenu');
        menu.classList.toggle('active');
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('mobileMenu');
        const toggle = document.querySelector('.navbar-toggle');

        if (!menu.contains(event.target) && !toggle.contains(event.target)) {
            menu.classList.remove('active');
        }
    });


    let status = currentStatus;
    const pendingTimeStr = [[${pendingDateTime}]];
    const completeTimeStr = [[${completeDateTime}]];
    const cancelledTimeStr = [[${cancelledDateTime}]];
    const noShowTimeStr = [[${noShowDateTime}]];

    // Convert UTC times to local Date objects
    const startTime = convertUTCToLocal(pendingTimeStr);
    const countupElement = document.getElementById("countup");


    function updateCountUp() {
        let diff;

        if(status === 'Complete' && completeTimeStr) {
            const finishTime = convertUTCToLocal(completeTimeStr);
            diff = finishTime - startTime;
            clearInterval(checkReservationStatus);
        }
        else if(status === 'Cancelled' && cancelledTimeStr) {
            const finishTime = convertUTCToLocal(cancelledTimeStr);
            diff = finishTime - startTime;
            clearInterval(checkReservationStatus);
        }
        else if(status === 'No Show' && noShowTimeStr) {
            const finishTime = convertUTCToLocal(noShowTimeStr);
            diff = finishTime - startTime;
            clearInterval(checkReservationStatus);
        }
        else {
            const now = new Date();
            diff = now - startTime;
        }

        const hours = Math.floor(diff / 1000 / 3600);
        const minutes = Math.floor((diff / 1000 % 3600) / 60);
        const seconds = Math.floor((diff / 1000) % 60);

        countupElement.textContent =
            String(hours).padStart(2,'0') + ":" +
            String(minutes).padStart(2,'0') + ":" +
            String(seconds).padStart(2,'0');
    }

    if(status !== 'Complete' && status !== 'Cancelled' && status !== 'No Show') {
        setInterval(updateCountUp, 1000);
    }

    updateCountUp();

    function formatPhoneDisplay() {
        const phoneEl = document.getElementById('phoneDisplay');
        if (phoneEl) {
            let phone = phoneEl.textContent.replace(/\D/g, '');
            if (phone.startsWith('63')) {
                phone = phone.slice(2);
            }
            if (phone.length === 10) {
                phoneEl.textContent = '+63 ' + phone.slice(0, 3) + ' ' + phone.slice(3, 6) + ' ' + phone.slice(6);
            }
        }
    }

    formatPhoneDisplay();


    const reservationId = [[${reservationId}]];

    const cancelBtn = document.getElementById('cancelbtn');
    const changeBtn = document.getElementById('changebtn');
    const cancelBtnMobile = document.getElementById('cancelbtnmobile');
    const changeBtnMobile = document.getElementById('changebtnmobile');
    const queueCount = document.getElementById('queue');

    function updateButtons(status) {
        const isPending = status === "Pending";
        queueCount.style.display = isPending ? "inline-flex" : "none";
        cancelBtn.style.display = isPending ? "inline-flex" : "none";
        changeBtn.style.display = isPending ? "inline-flex" : "none";
        cancelBtnMobile.style.display = isPending ? "inline-flex" : "none";
        changeBtnMobile.style.display = isPending ? "inline-flex" : "none";
    }

    function updateCountUpColor(status){
        countupElement.classList.remove('Complete','Confirm','Pending','Cancelled','Seated','No.Show');
        countupElement.classList.add(status);

    }
    let activeSegments = [[${activeSegments}]];


    function updateProgressBar(status) {
        const statusMap = {
            'Pending': 6,
            'Confirm': 12,
            'Seated': 18,
            'Complete': 24,
            'Cancelled': 24,
            'No Show' : 24
        };
        const activeSegments = statusMap[status] || 0;
        // Get all progress segments
        const segments = document.querySelectorAll('.progress-bar .progress-segment');


        segments.forEach((segment, index) => {
            const i = index + 1; // because querySelectorAll is 0-based

            // Remove old classes
            segment.classList.remove('active','status-Pending', 'status-Completed', 'status-Cancelled','status-Seated','status-Confirm','status-No.Show'); // list all possible status classes

            // Add new classes if this segment should be active
            if (i <= activeSegments) {
                segment.classList.add('active');  // <-- this makes the segment "rise" or fill
                if (status) {
                    segment.classList.add(`status-${status}`);
                }
            }
        });
    }

    function updateStatusLabel(status) {
        const statusLabel = document.getElementById('statusLabel');

        if (!statusLabel) return;

        // Remove any old status-* classes dynamically
        statusLabel.classList.forEach(cls => {
            if (cls.startsWith('status-')) {
                statusLabel.classList.remove(cls);
            }
        });

        // Add new status class
        statusLabel.classList.add(`status-${status.replace(/\s+/g, '-')}`);

        // Update text
        statusLabel.textContent = status;
    }


    function checkReservationStatus() {
        fetch(`/reservation/status?reservationId=${reservationId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status !== currentStatus) {
                    console.log("Status changed:", data.status);
                    currentStatus = data.status;
                    updateButtons(currentStatus);
                    updateCountUpColor(currentStatus);
                    updateProgressBar(currentStatus);
                    updateStatusLabel(currentStatus);
                    updateCountUp();

                    // Stop polling when final state reached
                    if (
                        currentStatus === "Complete" ||
                        currentStatus === "Cancelled" ||
                        currentStatus === "No Show"
                    ) {
                        clearInterval(statusInterval);
                    }
                }
            })
            .catch(err => console.error("Status check failed", err));
    }

    // Initial state
    updateButtons(currentStatus);

    // Poll every 10 seconds
    const statusInterval = setInterval(checkReservationStatus, 10000);

</script>

<script>

    const form = document.getElementById('changeDetailsForm');
    const submitBtn = document.querySelector('.btn-submit');
    const phoneInput = document.getElementById('customerPhone');

    function openModal() {
        document.getElementById('modalOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
        document.body.style.overflow = 'auto';
        submitBtn.classList.remove('loading');
    }

    function closeModalOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeModal();
        }
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');

            if (value.startsWith('63')) {
                value = value.slice(2);
            }

            if (value.length > 0) {
                let formatted = '+63';
                if (value.length > 0) {
                    formatted += ' ' + value.slice(0, 3);
                }
                if (value.length > 3) {
                    formatted += ' ' + value.slice(3, 6);
                }
                if (value.length > 6) {
                    formatted += ' ' + value.slice(6, 10);
                }
                this.value = formatted;
            }
        });
    }

    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            return;
        }

        submitBtn.classList.add('loading');

        if (phoneInput) {
            const cleanPhone = phoneInput.value.replace(/\s/g, '');
            phoneInput.value = cleanPhone;
        }
    });

    submitBtn.addEventListener('mousedown', function() {
        if (!this.classList.contains('loading')) {
            this.style.transform = 'scale(0.98)';
        }
    });

    submitBtn.addEventListener('mouseup', function() {
        this.style.transform = '';
    });

    submitBtn.addEventListener('mouseleave', function() {
        this.style.transform = '';
    });
</script>
<script>
    function openCancelModal() {
        document.getElementById('cancelModalOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeCancelModal() {
        document.getElementById('cancelModalOverlay').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    function closeCancelModalOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeCancelModal();
        }
    }

    // Optional: close on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCancelModal();
        }
    });
</script>
<script>
    // Open seating modal
    function openSeatingModal() {
        const modal = document.getElementById('seatingModalOverlay');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        document.getElementById('seatingNotification').style.display = 'inline-block';
        document.getElementById('mobileMenuNotification').style.display = 'inline-block';
    }

    // Close seating modal
    function closeSeatingModal() {
        const modal = document.getElementById('seatingModalOverlay');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    function notificationIcon(){
        document.getElementById('showConfirm').style.display = 'inline-block';
        document.getElementById('showConfirmMobile').style.display = 'inline-block';
        document.querySelectorAll('.notification-dot').forEach(dot => {
            dot.style.display = 'inline-block';
        });
    }


    // Confirm seating
    function confirmSeating() {
        const confirmBtn = document.querySelector('.seating-btn-confirm');
        confirmBtn.classList.add('loading');

        // Simulate API call - Replace with your actual logic
        setTimeout(() => {
            alert('Seating confirmed! Redirecting to your table...');
            closeSeatingModal();
            confirmBtn.classList.remove('loading');

            // Add your actual confirmation logic here
            // Example: window.location.href = '/confirm-seating';
        }, 1500);
    }

    // Decline seating
    function declineSeating() {
        closeSeatingModal();
        // Add your actual decline logic here
    }

    // Close modal when clicking outside
    document.getElementById('seatingModalOverlay').addEventListener('click', function(event) {
        if (event.target === this) {
            closeSeatingModal();
        }
    });

    // Close modal with ESC key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSeatingModal();
        }
    });
</script>
</body>
</html>